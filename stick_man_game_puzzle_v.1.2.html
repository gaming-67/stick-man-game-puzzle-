<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stick Puzzle v3</title>
<style>
  html,body {
    margin:0; height:100%; overflow:hidden;
    background:#0f1724; color:#fff; font-family:sans-serif;
  }
  canvas { display:block; background:#0f1724; }
  #menu {
    position: fixed;
    inset: 0;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    flex-direction: column;
  }
  h1 { font-size: 36px; margin-bottom: 20px; }
  button {
    margin: 6px;
    padding: 10px 22px;
    font-size: 18px;
    border: none;
    border-radius: 6px;
    background: #3b82f6;
    color: white;
    cursor: pointer;
  }
  button:hover { background: #2563eb; }
  #ui {
    position: fixed;
    top: 10px;
    left: 10px;
    display: flex;
    gap: 10px;
    z-index: 5;
  }
</style>
</head>
<body>
<div id="menu">
  <h1>Stick Puzzle v3</h1>
  <button id="btn1p">1 Player</button>
  <button id="btn2p">2 Players</button>
  <p>Select Level:</p>
  <div id="levelSelect"></div>
</div>

<div id="ui">
  <span id="levelText"></span>
  <button id="restartBtn" style="display:none;">Restart</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;

let running = false;
let players = [];
let platforms = [];
let boxes = [];
let goals = [];
let currentLevel = 1;
let totalLevels = 3;
let mode = "1p";

const keys = {};
onkeydown = e => keys[e.code] = true;
onkeyup = e => keys[e.code] = false;

// ====== PLAYER CREATION ======
function makePlayer(x, y, color, controls) {
  return {x, y, w:20, h:50, vx:0, vy:0, color, controls, onGround:false};
}

// ====== GAME START ======
function startGame(m, lvl = 1) {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('restartBtn').style.display = 'inline';
  running = true;
  mode = m;
  currentLevel = lvl;
  loadLevel();
  loop();
}

// ====== LEVEL SETUP ======
function loadLevel() {
  const g = canvas.height - 60;
  platforms = [];
  boxes = [];
  goals = [];
  players = [];

  if (currentLevel === 1) {
    platforms = [
      {x:0,y:g,w:canvas.width,h:60},
      {x:200,y:g-150,w:200,h:15},
      {x:600,y:g-250,w:200,h:15},
      {x:950,y:g-180,w:180,h:15}
    ];
    boxes = [{x:220,y:g-190,w:40,h:40,vx:0,vy:0}];
    goals = mode==='2p'
      ? [{x:1000,y:g-240,w:40,h:60,color:'#38bdf8'},{x:1150,y:g-240,w:40,h:60,color:'white'}]
      : [{x:1000,y:g-240,w:40,h:60,color:'white'}];
  }

  else if (currentLevel === 2) {
    platforms = [
      {x:0,y:g,w:canvas.width,h:60},
      {x:150,y:g-200,w:150,h:15},
      {x:400,y:g-300,w:150,h:15},
      {x:700,y:g-150,w:200,h:15},
      {x:1100,y:g-250,w:200,h:15}
    ];
    boxes = [
      {x:180,y:g-240,w:40,h:40,vx:0,vy:0},
      {x:430,y:g-340,w:40,h:40,vx:0,vy:0}
    ];
    goals = mode==='2p'
      ? [{x:1200,y:g-310,w:40,h:60,color:'#38bdf8'},{x:1300,y:g-310,w:40,h:60,color:'white'}]
      : [{x:1200,y:g-310,w:40,h:60,color:'white'}];
  }

  else if (currentLevel === 3) {
    platforms = [
      {x:0,y:g,w:canvas.width,h:60},
      {x:200,y:g-100,w:150,h:15},
      {x:450,y:g-200,w:200,h:15},
      {x:800,y:g-300,w:250,h:15},
      {x:1200,y:g-180,w:250,h:15}
    ];
    boxes = [
      {x:230,y:g-140,w:40,h:40,vx:0,vy:0},
      {x:480,y:g-240,w:40,h:40,vx:0,vy:0},
      {x:850,y:g-340,w:40,h:40,vx:0,vy:0}
    ];
    goals = mode==='2p'
      ? [{x:1300,y:g-240,w:40,h:60,color:'#38bdf8'},{x:1450,y:g-240,w:40,h:60,color:'white'}]
      : [{x:1350,y:g-240,w:40,h:60,color:'white'}];
  }

  players = [makePlayer(100,g-200,'white',{left:'ArrowLeft',right:'ArrowRight',jump:'ArrowUp'})];
  if(mode==='2p') players.push(makePlayer(180,g-200,'#38bdf8',{left:'KeyA',right:'KeyD',jump:'KeyW'}));

  document.getElementById('levelText').textContent = `Level ${currentLevel}`;
}

// ====== PLAYER + BOX PHYSICS ======
function updatePlayer(p, others){
  const spd = 4;
  if(keys[p.controls.left]) p.vx = -spd;
  else if(keys[p.controls.right]) p.vx = spd;
  else p.vx = 0;
  if(keys[p.controls.jump] && p.onGround){
    p.vy = -14;
    p.onGround = false;
  }
  p.vy += 0.7; 
  p.x += p.vx;
  p.y += p.vy;

  p.onGround = false;
  for(const plat of platforms){
    if(p.x + p.w > plat.x && p.x < plat.x + plat.w &&
       p.y + p.h > plat.y && p.y + p.h < plat.y + 20 && p.vy >= 0){
         p.y = plat.y - p.h;
         p.vy = 0;
         p.onGround = true;
    }
  }

  // Stand on boxes
  for(const b of boxes){
    if(p.x + p.w > b.x && p.x < b.x + b.w &&
       p.y + p.h > b.y && p.y + p.h < b.y + 20 && p.vy >= 0){
         p.y = b.y - p.h;
         p.vy = 0;
         p.onGround = true;
    }
  }

  // Stand on other players (head jump!)
  for(const o of others){
    if(p !== o && p.x + p.w > o.x && p.x < o.x + o.w &&
       p.y + p.h > o.y && p.y + p.h < o.y + 15 && p.vy >= 0){
         p.y = o.y - p.h;
         p.vy = 0;
         p.onGround = true;
    }
  }

  // Push boxes
  for(const b of boxes){
    if(p.x + p.w > b.x && p.x < b.x + b.w &&
       p.y + p.h > b.y && p.y < b.y + b.h){
      if(p.vx > 0) b.x += 2;
      else if(p.vx < 0) b.x -= 2;
    }
  }
}

function updateBoxes(){
  for(const b of boxes){
    b.vy += 0.7;
    b.y += b.vy;
    for(const plat of platforms){
      if(b.x + b.w > plat.x && b.x < plat.x + plat.w &&
         b.y + b.h > plat.y && b.y + b.h < plat.y + 20 && b.vy >= 0){
        b.y = plat.y - b.h;
        b.vy = 0;
      }
    }
  }
}

// ====== DRAWING ======
function drawPlayer(p){
  const cx = p.x + p.w/2;
  ctx.strokeStyle = p.color;
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.arc(cx,p.y+10,8,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,p.y+18); ctx.lineTo(cx,p.y+38); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,p.y+25); ctx.lineTo(cx-10,p.y+35); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,p.y+25); ctx.lineTo(cx+10,p.y+35); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,p.y+38); ctx.lineTo(cx-8,p.y+50); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,p.y+38); ctx.lineTo(cx+8,p.y+50); ctx.stroke();
}
function drawPlatforms(){
  ctx.fillStyle = '#1e293b';
  for(const p of platforms) ctx.fillRect(p.x,p.y,p.w,p.h);
}
function drawBoxes(){
  ctx.fillStyle = '#64748b';
  for(const b of boxes) ctx.fillRect(b.x,b.y,b.w,b.h);
}
function drawGoals(){
  for(const g of goals){
    ctx.fillStyle = g.color;
    ctx.fillRect(g.x,g.y,g.w,g.h);
  }
}

// ====== WIN CONDITION ======
function checkWin(){
  let allReached = true;
  for(let i=0;i<players.length;i++){
    const p = players[i];
    const g = goals[i];
    if(!(p.x+p.w>g.x && p.x<g.x+g.w && p.y+p.h>g.y && p.y<g.y+g.h)){
      allReached = false;
    }
  }
  if(allReached){
    currentLevel++;
    if(currentLevel > totalLevels){
      ctx.fillStyle = 'rgba(0,0,0,0.8)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = 'white';
      ctx.font = '40px sans-serif';
      ctx.fillText('ðŸŽ‰ You Beat All Levels!', canvas.width/2-180, canvas.height/2);
      running = false;
    } else {
      loadLevel();
    }
  }
}

// ====== GAME LOOP ======
function loop(){
  if(!running) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPlatforms();
  drawBoxes();
  drawGoals();
  updateBoxes();
  for(const p of players){
    updatePlayer(p, players);
    drawPlayer(p);
  }
  checkWin();
  requestAnimationFrame(loop);
}

// ====== UI SETUP ======
document.getElementById('btn1p').onclick = () => startGame('1p', 1);
document.getElementById('btn2p').onclick = () => startGame('2p', 1);
document.getElementById('restartBtn').onclick = () => loadLevel();

// level select buttons
const levelSelect = document.getElementById('levelSelect');
for(let i=1;i<=3;i++){
  const btn = document.createElement('button');
  btn.textContent = "Level " + i;
  btn.onclick = () => startGame('2p', i);
  levelSelect.appendChild(btn);
}
</script>
</body>
</html>
